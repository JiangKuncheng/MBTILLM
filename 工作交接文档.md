 # MBTI推荐系统工作交接文档

## 系统概述

这是一个基于MBTI性格特征的智能内容推荐系统，通过分析用户行为和内容特征，为用户提供个性化推荐。

## 核心业务逻辑

### 1. 用户行为记录与MBTI更新

**业务逻辑**：
- 用户执行行为（点赞、收藏、评论等）时记录到数据库
- 当用户行为数达到50条时，自动触发MBTI档案更新
- 当帖子被操作用户数达到50时，自动更新帖子MBTI

**代码位置**：
- 接口：`main_api.py` → `record_user_behavior()`
- 业务逻辑：`database_service.py` → `record_user_behavior()`
- MBTI更新：`mbti_service.py` → `update_user_mbti_profile()`

**关键代码**：
```python
# 记录行为后自动检查MBTI更新
if behavior_count % threshold == 0:
    background_tasks.add_task(
        mbti_service.update_user_mbti_profile,
        request.user_id,
        True  # 强制更新
    )
```

### 2. 智能推荐策略

**业务逻辑**：
- 优先使用数据库中的MBTI数据进行相似度计算和排序
- 如果数据库无数据，直接从搜狐API获取内容
- 如果数据库有ID但无内容详情，自动从搜狐API补充

**代码位置**：
- 主推荐接口：`main_api.py` → `get_user_recommendations()`
- 相似内容推荐：`main_api.py` → `get_similar_content_recommendations()`

**关键代码**：
```python
# 数据库优先策略
if not recommendations.get('recommendations'):
    # 搜狐API兜底
    article_result = await client.get_article_list(page_size=limit)
    # 转换为推荐格式
```

### 3. 可配置的MBTI评分模式

**业务逻辑**：
- 支持三种模式：AI评分、随机数生成、混合模式
- 可通过API动态切换评分模式
- 影响内容MBTI评分和用户推荐质量

**代码位置**：
- 配置管理：`main_api.py` → `AI_SCORING_MODE` 全局变量
- 模式切换：`main_api.py` → `/api/v1/system/mbti-scoring-mode`
- 评分实现：`main_api.py` → `evaluate_content_mbti()`

**关键代码**：
```python
if current_mode == "random":
    probabilities = generate_consistent_random_mbti_scores()
elif current_mode == "ai":
    probabilities = await mbti_service.evaluate_content_mbti(...)
```

### 4. 推荐分页与进度跟踪

**业务逻辑**：
- 支持分页推荐，每页默认20条
- 自动记录用户推荐进度，下次请求自动翻页
- 避免重复推荐相同内容

**代码位置**：
- 分页逻辑：`main_api.py` → `get_user_recommendations()`
- 进度管理：`database_service.py` → `update_user_recommendation_progress()`

**关键代码**：
```python
# 自动获取下一推荐页数
if page is None and auto_page:
    actual_page = db_service.get_next_recommendation_page(user_id)
```

## 数据库结构

### 主要表说明

**1. `user_mbti_profiles` - 用户MBTI档案**
- 存储用户MBTI概率分布、类型、置信度
- 新增：`current_recommendation_page`（当前推荐页数）、`last_recommendation_time`（最后推荐时间）

**2. `user_post_history` - 用户行为记录**
- 记录用户所有操作行为（点赞、收藏、评论等）
- 包含行为权重、来源、时间等信息

**3. `mbti_post_evaluations` - 内容MBTI评价**
- 存储内容MBTI评分和帖子详细信息
- 新增：`title`、`cover_image`、`author`、`publish_time`等字段

**4. `recommendation_logs` - 推荐日志**
- 记录每次推荐的结果和算法信息
- 用于分析和优化推荐算法

### 关键字段说明

```sql
-- 用户档案表新增字段
current_recommendation_page: 当前推荐到的页数
last_recommendation_time: 最后推荐时间

-- 内容评价表新增字段  
title: 帖子标题
cover_image: 封面图URL
author: 作者名称
publish_time: 发布时间
```

## 代码文件对应关系

### 核心业务文件

| 业务功能 | 主要文件 | 关键方法 |
|---------|---------|---------|
| API接口 | `main_api.py` | 所有REST接口实现 |
| 数据库操作 | `database_service.py` | 数据增删改查 |
| MBTI评分 | `mbti_service.py` | AI评分、档案更新 |
| 外部API | `sohu_client.py` | 搜狐内容获取 |
| 数据模型 | `models.py` | 表结构定义 |

### 关键方法映射

**用户行为管理**：
- `database_service.record_user_behavior()` - 记录行为
- `database_service.increment_behavior_count()` - 增加计数
- `mbti_service.update_user_mbti_profile()` - 更新MBTI

**推荐生成**：
- `database_service.get_recommendations_for_user()` - 获取推荐
- `database_service.calculate_mbti_similarity()` - 计算相似度
- `sohu_client.get_article_list()` - 获取搜狐内容

**内容管理**：
- `database_service.update_content_info()` - 更新内容信息
- `database_service.save_content_mbti()` - 保存MBTI评分

## 配置说明

### 重要配置项

**`new_config.py`**：
- `DEBUG`: 控制热重载（生产环境设为False）
- `HOST/PORT`: 服务地址和端口
- `SILICONFLOW_CONFIG`: 大语言模型API配置
- `SOHU_CONFIG`: 搜狐API配置

**环境变量**：
- `DEBUG`: 调试模式开关
- `HOST`: 服务主机地址
- `PORT`: 服务端口

## 常见问题处理

### 1. 推荐返回空结果
- 检查数据库是否有MBTI数据
- 检查搜狐API是否正常
- 查看日志中的错误信息

### 2. 用户MBTI不更新
- 检查行为计数是否达到50条阈值
- 检查后台任务是否正常执行
- 查看MBTI更新日志

### 3. 内容详情缺失
- 检查搜狐API返回状态
- 检查内容ID是否有效
- 查看内容同步日志

## 扩展开发指南

### 添加新的推荐算法
1. 在 `database_service.py` 中实现新方法
2. 在 `main_api.py` 中调用新方法
3. 更新推荐接口逻辑

### 添加新的内容源
1. 创建新的客户端类（参考 `sohu_client.py`）
2. 在推荐逻辑中集成新内容源
3. 更新数据模型和存储逻辑

### 修改MBTI评分逻辑
1. 在 `mbti_service.py` 中修改评分方法
2. 更新提示词配置
3. 测试评分准确性

## 部署注意事项

1. **数据库初始化**：首次运行会自动创建表结构
2. **API密钥配置**：确保搜狐API和大语言模型API密钥正确
3. **日志监控**：关注MBTI更新和推荐生成的日志
4. **性能优化**：根据实际使用情况调整推荐数量和分页大小

这个系统通过MBTI特征分析实现智能推荐，通过搜狐API获取丰富内容，通过数据库管理用户行为，形成了一个完整的个性化推荐生态。